<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Instruction (lmn.Generator__.Instruction)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">lmn</a> &#x00BB; <a href="../index.html">Generator__</a> &#x00BB; Instruction</nav><h1>Module <code>Generator__.Instruction</code></h1></header><aside><p>Instructions of the intermediate code</p></aside><dl><dt class="spec type" id="type-reg_i"><a href="#type-reg_i" class="anchor"></a><code><span class="keyword">type</span> reg_i</code><code> = int</code></dt><dd><p>レジスタ番号</p></dd></dl><dl><dt class="spec type" id="type-functor_"><a href="#type-functor_" class="anchor"></a><code><span class="keyword">type</span> functor_</code><code> = string * int</code></dt><dd><p>ファンクタ := (アトム名, リンクの数)</p></dd></dl><aside><p>アトムのデータ構造としてとりあえず前提としているもの</p><ul><li><code>type atom = string * link list
        and  link = NormalLink of int * atom ref (* | ... *)
       </code></li><li>ただし，<code>int * atom ref</code> はそれぞれアトムへの参照とその先でどの番号のポートに接続されているか を表す</li></ul></aside><dl><dt class="spec type" id="type-lhs_inst"><a href="#type-lhs_inst" class="anchor"></a><code><span class="keyword">type</span> lhs_inst</code><code> = </code><table class="variant"><tr id="type-lhs_inst.PeakAtom" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.PeakAtom" class="anchor"></a><code>| </code><code><span class="constructor">PeakAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-functor_">functor_</a></code></td><td class="doc"><p>アトムリストの先頭から随時，ファンクタが <code>functor_</code> であるアトムへの参照を， レジスタ <code>reg_i</code> に格納してゆく</p><ul><li>failable and possibly rewind</li></ul></td></tr><tr id="type-lhs_inst.CheckFunctor" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckFunctor" class="anchor"></a><code>| </code><code><span class="constructor">CheckFunctor</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-functor_">functor_</a></code></td><td class="doc"><p><code>reg_i</code> に格納したアトムのファンクタが <code>functor_</code> であることを確認する</p><ul><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.DerefAtom" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.DerefAtom" class="anchor"></a><code>| </code><code><span class="constructor">DerefAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a> * int * int</code></td><td class="doc"><p><code>DerefAtom dst_reg_i src_reg_i src_port_i dst_port_i</code> は， レジスタ <code>src_reg_i</code> が参照するアトムの <code>src_port_i</code> 番目の引数の持つアトムへの参照を このリンクが相手先で <code>dst_port_i</code> 番目の引数に接続されていることを確認して レジスタ <code>dst_reg_i</code> に格納する</p><ul><li>failable and does not rewind</li><li>（通常のリンクではなかったときも失敗するようにしようと思っていたけど，そうしないことにする？）</li><li>基本的に局所リンクのマッチングに用いる</li></ul></td></tr><tr id="type-lhs_inst.CheckRefEq" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckRefEq" class="anchor"></a><code>| </code><code><span class="constructor">CheckRefEq</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>CheckRefEq reg_i reg_j</code> は レジスタ <code>reg_i</code> に格納されているアドレスと レジスタ <code>reg_j</code> に格納されているアドレスが等しいことを確認する</p><ul><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.CheckRefNeq" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.CheckRefNeq" class="anchor"></a><code>| </code><code><span class="constructor">CheckRefNeq</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>CheckRefEq reg_i reg_j</code> は レジスタ <code>reg_i</code> に格納されているアドレスと レジスタ <code>reg_j</code> に格納されているアドレスが異なることを確認する</p><ul><li>failable and does not rewind</li></ul></td></tr><tr id="type-lhs_inst.BindData" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.BindData" class="anchor"></a><code>| </code><code><span class="constructor">BindData</span> <span class="keyword">of</span> string * <a href="index.html#type-reg_i">reg_i</a> * int</code></td><td class="doc"><p><code>BindData var src_reg_i src_port_i</code> は レジスタ <code>src_reg_i</code> が参照するアトムのポート <code>src_port_i</code> 番目のデータアトムを 変数 <code>var</code> に束縛する</p><ul><li>今は完全にインタプリタ方式だが，より低レベルな命令列に変更する必要がある．</li></ul></td></tr><tr id="type-lhs_inst.FailMatching" class="anchored"><td class="def constructor"><a href="#type-lhs_inst.FailMatching" class="anchor"></a><code>| </code><code><span class="constructor">FailMatching</span> <span class="keyword">of</span> string</code></td><td class="doc"><p>仮想マシンを（途中で）強制終了する．デバッグのための命令</p></td></tr></table></dt><dd><p>ルール左辺におけるマッチングのための中間命令</p><ul><li>failable は失敗する可能性があるということ</li><li>rewind は後続の命令が失敗したときに巻き戻しの起点になるということ</li><li>レジスタに格納するデータはアトムへの参照のみ</li><li><code>type register = atom ref</code></li></ul></dd></dl><dl><dt class="spec type" id="type-lhs_insts"><a href="#type-lhs_insts" class="anchor"></a><code><span class="keyword">type</span> lhs_insts</code><code> = <span><a href="index.html#type-lhs_inst">lhs_inst</a> list</span></code></dt><dt class="spec type" id="type-rhs_inst"><a href="#type-rhs_inst" class="anchor"></a><code><span class="keyword">type</span> rhs_inst</code><code> = </code><table class="variant"><tr id="type-rhs_inst.PushAtom" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.PushAtom" class="anchor"></a><code>| </code><code><span class="constructor">PushAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * <a href="index.html#type-functor_">functor_</a></code></td><td class="doc"><p><code>PushAtom reg_i functor_</code> は， ルール右辺で生成する，ファンクタ <code>functor_</code> の（シンボル）アトムを生成し，レジスタ <code>reg_i</code> に代入する</p><ul><li>アトムリストへの追加も行う</li><li>ただし，リンクの値は正しい値にセットされない</li></ul></td></tr><tr id="type-rhs_inst.FreeAtom" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.FreeAtom" class="anchor"></a><code>| </code><code><span class="constructor">FreeAtom</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a></code></td><td class="doc"><p><code>FreeAtom reg_i</code> は， レジスタ <code>reg_i</code> が参照する先のアトムをアトムリストから除去し，メモリを解放する</p></td></tr><tr id="type-rhs_inst.SetLink" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.SetLink" class="anchor"></a><code>| </code><code><span class="constructor">SetLink</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * int * <a href="index.html#type-reg_i">reg_i</a> * int</code></td><td class="doc"><p><code>SetLink reg_i port_i reg_j port_j</code> は， レジスタ <code>reg_i</code> が参照するアトムの <code>port_i</code> 番目のリンクと レジスタ <code>reg_j</code> が参照するアトムの <code>port_j</code> 番目のリンクを結ぶ</p><ul><li>基本的に局所リンクのための命令</li></ul></td></tr><tr id="type-rhs_inst.ReLink" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.ReLink" class="anchor"></a><code>| </code><code><span class="constructor">ReLink</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * int * <a href="index.html#type-reg_i">reg_i</a> * int</code></td><td class="doc"><p><code>ReLink reg_i port_i reg_j port_j</code> は， レジスタ <code>reg_i</code> が参照するルール右辺で生成したアトムの <code>port_i</code> 番目のリンクと レジスタ <code>reg_j</code> が参照するルール左辺でマッチしたアトムの <code>port_j</code> 番目のリンクを繋ぐ</p><ul><li>リンクオブジェクトは，基本的には，参照先のアトムと，参照先でのポート番号の組になっている</li><li>基本的に自由リンクのための命令</li></ul></td></tr><tr id="type-rhs_inst.Connect" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.Connect" class="anchor"></a><code>| </code><code><span class="constructor">Connect</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * int * <a href="index.html#type-reg_i">reg_i</a> * int</code></td><td class="doc"><p><code>Connect reg_i reg_j</code> は， レジスタ <code>reg_i</code> が参照するルール左辺でマッチしたアトムの <code>port_i</code> 番目のリンクと レジスタ <code>reg_j</code> が参照するルール左辺でマッチしたアトムの <code>port_j</code> 番目のリンクとを結ぶ</p><ul><li>リンクオブジェクトは，基本的には，参照先のアトムと，参照先でのポート番号の組になっている</li><li>自由リンク同士を接続するために用いる</li></ul></td></tr><tr id="type-rhs_inst.SetData" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.SetData" class="anchor"></a><code>| </code><code><span class="constructor">SetData</span> <span class="keyword">of</span> <a href="index.html#type-reg_i">reg_i</a> * int * string</code></td><td class="doc"><p><code>PushData reg_i port_i var</code> は， ルール右辺で生成する，変数 <code>var</code> に束縛されたデータアトムを生成し， レジスタ <code>reg_i</code> 番目のアトムの，ポート <code>port_i</code> にセットする</p><ul><li>アトムリストへの追加は行わない</li><li>今は完全にインタプリタ方式だが，より低レベルな命令列に変更する必要がある．</li></ul></td></tr><tr id="type-rhs_inst.FailPushout" class="anchored"><td class="def constructor"><a href="#type-rhs_inst.FailPushout" class="anchor"></a><code>| </code><code><span class="constructor">FailPushout</span> <span class="keyword">of</span> string</code></td><td class="doc"><p>仮想マシンを（途中で）強制終了する．デバッグのための命令</p></td></tr></table></dt><dd><p>ルール右辺におけるマッチングのための中間命令． どれも失敗することはない．</p></dd></dl><dl><dt class="spec type" id="type-rhs_insts"><a href="#type-rhs_insts" class="anchor"></a><code><span class="keyword">type</span> rhs_insts</code><code> = <span><a href="index.html#type-rhs_inst">rhs_inst</a> list</span></code></dt></dl><aside><p>中間コードを文字列へ変換する</p><ul><li>中間命令列のファイルを生成するため</li><li>とデバッグ時の dump のため</li></ul></aside><dl><dt class="spec value" id="val-string_of_functor"><a href="#val-string_of_functor" class="anchor"></a><code><span class="keyword">val</span> string_of_functor : <span>(string * int)</span> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_lhs_inst"><a href="#val-string_of_lhs_inst" class="anchor"></a><code><span class="keyword">val</span> string_of_lhs_inst : <a href="index.html#type-lhs_inst">lhs_inst</a> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_rhs_inst"><a href="#val-string_of_rhs_inst" class="anchor"></a><code><span class="keyword">val</span> string_of_rhs_inst : <a href="index.html#type-rhs_inst">rhs_inst</a> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_lhs_insts"><a href="#val-string_of_lhs_insts" class="anchor"></a><code><span class="keyword">val</span> string_of_lhs_insts : <span><a href="index.html#type-lhs_inst">lhs_inst</a> list</span> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_rhs_insts"><a href="#val-string_of_rhs_insts" class="anchor"></a><code><span class="keyword">val</span> string_of_rhs_insts : <span><a href="index.html#type-rhs_inst">rhs_inst</a> list</span> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_rule"><a href="#val-string_of_rule" class="anchor"></a><code><span class="keyword">val</span> string_of_rule : <span>(string * <span>(int * <span>(<span><a href="index.html#type-lhs_inst">lhs_inst</a> list</span> * <span><a href="../../Parse__/Syntax/index.html#type-arg">Parse__.Syntax.arg</a> list</span> * <span><a href="index.html#type-rhs_inst">rhs_inst</a> list</span>)</span>)</span>)</span> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-break_line"><a href="#val-break_line" class="anchor"></a><code><span class="keyword">val</span> break_line : string <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_prog"><a href="#val-string_of_prog" class="anchor"></a><code><span class="keyword">val</span> string_of_prog : <span>(<span>(int * <span><a href="index.html#type-rhs_inst">rhs_inst</a> list</span>)</span> * <span><span>(string * <span>(int * <span>(<span><a href="index.html#type-lhs_inst">lhs_inst</a> list</span> * <span><a href="../../Parse__/Syntax/index.html#type-arg">Parse__.Syntax.arg</a> list</span> * <span><a href="index.html#type-rhs_inst">rhs_inst</a> list</span>)</span>)</span>)</span> list</span>)</span> <span>&#45;&gt;</span> string</code></dt></dl></div></body></html>